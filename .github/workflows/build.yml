name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            artifact_name: 'macos-aarch64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            artifact_name: 'macos-x86_64'
          - platform: 'windows-latest'
            args: ''
            artifact_name: 'windows'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: pnpm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          args: ${{ matrix.args }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            src-tauri/target/release/bundle/**/*.dmg
            src-tauri/target/release/bundle/**/*.app.tar.gz
            src-tauri/target/release/bundle/**/*.app.tar.gz.sig
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.msi.sig
            src-tauri/target/aarch64-apple-darwin/release/bundle/**/*.dmg
            src-tauri/target/aarch64-apple-darwin/release/bundle/**/*.app.tar.gz
            src-tauri/target/aarch64-apple-darwin/release/bundle/**/*.app.tar.gz.sig
            src-tauri/target/x86_64-apple-darwin/release/bundle/**/*.dmg
            src-tauri/target/x86_64-apple-darwin/release/bundle/**/*.app.tar.gz
            src-tauri/target/x86_64-apple-darwin/release/bundle/**/*.app.tar.gz.sig

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: find artifacts -type f | head -50

      - name: Prepare release files
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p release-files

          echo "=== Artifact structure ==="
          find artifacts -type f

          # Find and copy tar.gz files with version naming
          # macOS aarch64
          AARCH64_TAR=$(find artifacts/macos-aarch64 -name "*.app.tar.gz" -type f 2>/dev/null | head -1)
          if [ -n "$AARCH64_TAR" ]; then
            cp "$AARCH64_TAR" "release-files/TutorMate_${VERSION}_aarch64.app.tar.gz"
            echo "Copied aarch64 tar.gz"
          fi
          AARCH64_SIG=$(find artifacts/macos-aarch64 -name "*.app.tar.gz.sig" -type f 2>/dev/null | head -1)
          if [ -n "$AARCH64_SIG" ]; then
            cp "$AARCH64_SIG" "release-files/TutorMate_${VERSION}_aarch64.app.tar.gz.sig"
            echo "Copied aarch64 sig"
          fi

          # macOS x86_64
          X64_TAR=$(find artifacts/macos-x86_64 -name "*.app.tar.gz" -type f 2>/dev/null | head -1)
          if [ -n "$X64_TAR" ]; then
            cp "$X64_TAR" "release-files/TutorMate_${VERSION}_x64.app.tar.gz"
            echo "Copied x64 tar.gz"
          fi
          X64_SIG=$(find artifacts/macos-x86_64 -name "*.app.tar.gz.sig" -type f 2>/dev/null | head -1)
          if [ -n "$X64_SIG" ]; then
            cp "$X64_SIG" "release-files/TutorMate_${VERSION}_x64.app.tar.gz.sig"
            echo "Copied x64 sig"
          fi

          # Copy dmg, exe, msi files
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.msi" -o -name "*.msi.sig" \) -exec cp {} release-files/ \;

          echo "=== Release files ==="
          ls -la release-files/

      - name: Generate latest.json for updater
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          # Get signature files content
          MAC_AARCH64_SIG=""
          MAC_X86_64_SIG=""
          WINDOWS_SIG=""

          if [ -f "release-files/TutorMate_${VERSION}_aarch64.app.tar.gz.sig" ]; then
            MAC_AARCH64_SIG=$(cat "release-files/TutorMate_${VERSION}_aarch64.app.tar.gz.sig")
          fi

          if [ -f "release-files/TutorMate_${VERSION}_x64.app.tar.gz.sig" ]; then
            MAC_X86_64_SIG=$(cat "release-files/TutorMate_${VERSION}_x64.app.tar.gz.sig")
          fi

          if [ -f "release-files/TutorMate_${VERSION}_x64-setup.msi.sig" ]; then
            WINDOWS_SIG=$(cat "release-files/TutorMate_${VERSION}_x64-setup.msi.sig")
          fi

          cat > release-files/latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "새로운 버전이 출시되었습니다.",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-aarch64": {
                "signature": "${MAC_AARCH64_SIG}",
                "url": "https://github.com/rlawlghkd12/tutomate/releases/download/${GITHUB_REF_NAME}/TutorMate_${VERSION}_aarch64.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "${MAC_X86_64_SIG}",
                "url": "https://github.com/rlawlghkd12/tutomate/releases/download/${GITHUB_REF_NAME}/TutorMate_${VERSION}_x64.app.tar.gz"
              },
              "windows-x86_64": {
                "signature": "${WINDOWS_SIG}",
                "url": "https://github.com/rlawlghkd12/tutomate/releases/download/${GITHUB_REF_NAME}/TutorMate_${VERSION}_x64-setup.msi"
              }
            }
          }
          EOF

          cat release-files/latest.json

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing release if exists
          gh release delete ${{ github.ref_name }} --yes 2>/dev/null || true

          # Create new release with files
          gh release create ${{ github.ref_name }} \
            --title "수강생 관리 프로그램 ${{ github.ref_name }}" \
            --notes "새로운 버전이 출시되었습니다.

          자동 업데이트를 통해 최신 버전으로 업데이트하거나, 아래에서 직접 다운로드할 수 있습니다.

          ## 설치 방법

          ### macOS
          - Apple Silicon (M1/M2): \`TutorMate_*_aarch64.dmg\` 다운로드
          - Intel Mac: \`TutorMate_*_x64.dmg\` 다운로드

          ### Windows
          - \`.exe\` 또는 \`.msi\` 파일 다운로드" \
            release-files/*

  # 테스트 빌드용 (태그 없이 실행)
  test-build:
    if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build Tauri app
        run: pnpm run tauri:build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            src-tauri/target/release/bundle/**/*
